{% extends "base.html" %}

{% block title %}Facturas{% endblock %}

{% block content %}
<div class="card">
    <div class="actions">
        <a class="btn btn-primary" href="/invoices/new">Nueva factura</a>
    </div>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Estado</th>
                    <th>Número</th>
                    <th>Cliente</th>
                    <th>Fecha emisión</th>
                    <th>Vencimiento</th>
                    <th>Moneda</th>
                    <th>IGI %</th>
                    <th>Subtotal</th>
                    <th>IGI</th>
                    <th>Total</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            {% for invoice in invoices %}
                {% set totals = invoice_totals.get(invoice.id) %}
                <tr>
                    <td>{{ invoice.id }}</td>
                    <td>{{ invoice.status }}</td>
                    <td>{{ invoice.invoice_number if invoice.invoice_number else "Draft" }}</td>
                    <td>
                        {% if invoice.status == 'issued' %}
                            {{ invoice.client_name_snapshot }}
                        {% else %}
                            {{ invoice.client.name if invoice.client else '' }}
                        {% endif %}
                    </td>
                    <td>{{ invoice.issue_date }}</td>
                    <td>{{ invoice.due_date }}</td>
                    <td>{{ invoice.currency }}</td>
                    <td>{{ invoice.igi_rate }}</td>
                    {% if invoice.status == 'issued' and invoice.total_snapshot is not none %}
                        <td>{{ "{:.2f}".format(invoice.subtotal_snapshot) }}</td>
                        <td>{{ "{:.2f}".format(invoice.igi_amount_snapshot) }}</td>
                        <td>{{ "{:.2f}".format(invoice.total_snapshot) }}</td>
                    {% else %}
                        <td>{{ "{:.2f}".format(totals.subtotal) if totals else "" }}</td>
                        <td>{{ "{:.2f}".format(totals.igi) if totals else "" }}</td>
                        <td>{{ "{:.2f}".format(totals.total) if totals else "" }}</td>
                    {% endif %}
                    <td class="table-actions"><a class="btn btn-secondary" href="/invoices/{{ invoice.id }}">Ver</a></td>
                </tr>
            {% else %}
                <tr>
                    <td colspan="12">No hay facturas.</td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}
